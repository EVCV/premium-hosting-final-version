---
import { getPosts, getPostBySlug } from '../../utils/wordpress-client';
import BlogLayout from '../../templates/layouts/BlogLayout.astro';
import TemplateRenderer from '../../components/TemplateRenderer.astro';
import templates from '../../data/templates.json';

export async function getStaticPaths() {
  try {
    const postsData = await getPosts(100);

    return postsData.posts.nodes.map((post: any) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error('Error fetching WordPress posts:', error);
    // Return empty array for now - will fallback to static content
    return [];
  }
}

const { slug } = Astro.params;
let post = null;

try {
  post = await getPostBySlug(slug);
} catch (error) {
  console.error(`Error fetching post ${slug}:`, error);
}

// Get template config for blog posts
const templateConfig = (templates as any)['blog'] || (templates as any).base;

// Pass post data to template
const postData = post ? {
  title: post.post.title,
  content: post.post.content,
  excerpt: post.post.excerpt,
  slug: post.post.slug,
  date: post.post.date,
  author: post.post.author?.node?.name,
} : {
  title: `Post: ${slug}`,
  content: '<div>Loading...</div>',
  slug: slug,
};
---

<BlogLayout title={postData.title} description={postData.excerpt}>
  <TemplateRenderer template={templateConfig} data={postData} />
</BlogLayout>

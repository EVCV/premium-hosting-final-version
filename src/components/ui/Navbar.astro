---
import { Image } from "astro:assets";
import { NAV_LINKS } from "../../constants";

const navLinks = NAV_LINKS;

import bars from "../../assets/bars.svg";
import brand from "../../assets/premium-hosting-horizontal-logo.svg";
import chevron from "../../assets/chevron.svg";
---

<div
  class="bg-[#fff] fixed w-full top-0 z-50 py-[20px] h-auto flex justify-center border-b border-gray-100"
>
  <nav
    aria-label="Main Navigation"
    role="navigation"
    class="w-full flex h-full items-center justify-between px-4"
    style="max-width: var(--navbar-max-width);"
  >
    <!-- Brand -->
    <div class="flex-none">
      <a href="/">
        <Image src={brand} alt="Premium Hosting Logo" class="w-[200px] h-auto" loading="eager" />
      </a>
    </div>

    <!-- Nav Menu -->
    <div
      id="navmenu"
      class="bg-[#fff] w-full absolute top-full left-0 z-40 xl:static xl:flex xl:flex-grow xl:items-center xl:justify-center overflow-hidden transition-all duration-300 max-h-0 xl:max-h-none border-b border-gray-100 xl:border-b-0"
    >
      <!-- Nav Links -->
      <ul class="xl:flex xl:flex-grow xl:justify-center xl:gap-8 py-4 xl:py-0">
        {
          navLinks.map((link) => {
            if ('isDropdown' in link && link.isDropdown && 'children' in link && link.children) {
              return (
                <li class="relative group mx-4 xl:mx-0">
                  <button 
                    class="nav-dropdown-trigger flex items-center gap-2 py-3 xl:py-2 text-gray-700 hover:text-gold transition-colors font-medium"
                    aria-expanded="false"
                    data-dropdown={link.name.toLowerCase()}
                  >
                    {link.name}
                    <Image src={chevron} alt="" class="w-4 h-4 transition-transform duration-200 group-hover:rotate-180" />
                  </button>
                  
                  <!-- Mega Menu Dropdown -->
                  <div class="mega-menu hidden xl:group-hover:block xl:absolute xl:top-full xl:left-1/2 xl:transform xl:-translate-x-1/2 xl:mt-2">
                    <div class="mega-menu-content bg-white rounded-2xl shadow-2xl border border-gray-100 p-8 min-w-[600px]">
                      <div class="grid grid-cols-2 gap-8">
                        {link.children.map((category: any) => (
                          <div class="category-section">
                            <h3 class="font-semibold text-gray-900 mb-4 text-sm uppercase tracking-wide">
                              {category.category}
                            </h3>
                            <ul class="space-y-3">
                              {category.items.map((item: any) => (
                                <li>
                                  <a 
                                    href={item.href}
                                    class="mega-menu-item block p-3 rounded-lg hover:bg-gray-50 transition-all duration-200 group"
                                  >
                                    <div class="font-medium text-gray-900 group-hover:text-gold transition-colors">
                                      {item.name}
                                    </div>
                                    <div class="text-sm text-gray-500 mt-1">
                                      {item.description}
                                    </div>
                                  </a>
                                </li>
                              ))}
                            </ul>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  <!-- Mobile Dropdown -->
                  <div class="mobile-dropdown xl:hidden overflow-hidden max-h-0 transition-all duration-300">
                    <div class="bg-gray-50 rounded-lg mt-2 p-4">
                      {link.children.map((category: any) => (
                        <div class="mb-6 last:mb-0">
                          <h4 class="font-semibold text-gray-900 mb-3 text-sm">
                            {category.category}
                          </h4>
                          <ul class="space-y-2">
                            {category.items.map((item: any) => (
                              <li>
                                <a href={item.href} class="block text-gray-600 hover:text-gold transition-colors py-1">
                                  {item.name}
                                </a>
                              </li>
                            ))}
                          </ul>
                        </div>
                      ))}
                    </div>
                  </div>
                </li>
              );
            } else {
              return (
                <li class="mx-4 xl:mx-0">
                  <a 
                    href={link.href} 
                    class="block py-3 xl:py-2 text-gray-700 hover:text-gold transition-colors font-medium"
                  >
                    {link.name}
                  </a>
                </li>
              );
            }
          })
        }
      </ul>

      <!-- CTA Buttons -->
      <div class="flex xl:flex-row xl:items-center px-4 xl:px-0 xl:gap-4 flex-col gap-3 pb-4 xl:pb-0">
        <a href="/contact" class="btn-secondary text-center">
          Get Quote
        </a>
        <a href="https://cp.premium-hosting.co.uk" class="btn-primary text-center" target="_blank">
          Client Area
        </a>
      </div>
    </div>

    <!-- Hamburger menu -->
    <button
      aria-label="Toggle navigation menu"
      role="button"
      aria-controls="navmenu"
      aria-expanded="false"
      id="menuButton"
      class="w-10 h-10 xl:hidden flex items-center justify-center"
    >
      <Image src={bars} alt="Menu" class="w-6 h-6" />
    </button>
  </nav>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const menuButton = document.getElementById("menuButton");
    const navMenu = document.getElementById("navmenu");
    const dropdownTriggers = document.querySelectorAll(".nav-dropdown-trigger");

    let isMenuOpen = false;

    // Mobile menu toggle
    if (menuButton && navMenu) {
      menuButton.addEventListener("click", () => {
        isMenuOpen = !isMenuOpen;
        menuButton.setAttribute("aria-expanded", `${isMenuOpen}`);

        if (isMenuOpen) {
          navMenu.style.maxHeight = `${navMenu.scrollHeight + 100}px`;
        } else {
          navMenu.style.maxHeight = "0px";
          // Close any open mobile dropdowns
          document.querySelectorAll(".mobile-dropdown").forEach(dropdown => {
            (dropdown as HTMLElement).style.maxHeight = "0px";
          });
        }
      });

      // Close menu when clicking on links
      navMenu.addEventListener("click", (e) => {
        if (e.target && (e.target as HTMLElement).tagName === "A" && !(e.target as HTMLElement).closest(".nav-dropdown-trigger")) {
          if (isMenuOpen && window.innerWidth < 1280) {
            isMenuOpen = false;
            navMenu.style.maxHeight = "0px";
            menuButton.setAttribute("aria-expanded", "false");
          }
        }
      });

      // Handle window resize
      window.addEventListener("resize", () => {
        if (window.innerWidth >= 1280) {
          navMenu.style.maxHeight = "none";
          isMenuOpen = false;
          menuButton.setAttribute("aria-expanded", "false");
        } else if (!isMenuOpen) {
          navMenu.style.maxHeight = "0px";
        }
      });
    }

    // Mobile dropdown functionality
    dropdownTriggers.forEach(trigger => {
      trigger.addEventListener("click", (e) => {
        if (window.innerWidth < 1280) {
          e.preventDefault();
          
          const dropdown = trigger.nextElementSibling?.nextElementSibling as HTMLElement; // Skip mega menu, get mobile dropdown
          const isExpanded = trigger.getAttribute("aria-expanded") === "true";

          // Close all other mobile dropdowns
          dropdownTriggers.forEach(otherTrigger => {
            if (otherTrigger !== trigger) {
              otherTrigger.setAttribute("aria-expanded", "false");
              const otherDropdown = otherTrigger.nextElementSibling?.nextElementSibling as HTMLElement;
              if (otherDropdown) {
                otherDropdown.style.maxHeight = "0px";
              }
            }
          });

          // Toggle current dropdown
          if (!isExpanded && dropdown) {
            trigger.setAttribute("aria-expanded", "true");
            dropdown.style.maxHeight = `${dropdown.scrollHeight}px`;
            
            // Update main nav menu height
            setTimeout(() => {
              if (navMenu) {
                navMenu.style.maxHeight = `${navMenu.scrollHeight}px`;
              }
            }, 10);
          } else if (dropdown) {
            trigger.setAttribute("aria-expanded", "false");
            dropdown.style.maxHeight = "0px";
            
            // Update main nav menu height
            setTimeout(() => {
              if (navMenu) {
                navMenu.style.maxHeight = `${navMenu.scrollHeight}px`;
              }
            }, 300);
          }
        }
      });
    });

    // Desktop mega menu hover effects
    document.querySelectorAll(".group").forEach(group => {
      const megaMenu = group.querySelector(".mega-menu") as HTMLElement;
      if (megaMenu) {
        let hoverTimeout: NodeJS.Timeout;

        group.addEventListener("mouseenter", () => {
          clearTimeout(hoverTimeout);
          megaMenu.style.display = "block";
          setTimeout(() => {
            megaMenu.style.opacity = "1";
            megaMenu.style.transform = "translateX(-50%) translateY(0)";
          }, 10);
        });

        group.addEventListener("mouseleave", () => {
          megaMenu.style.opacity = "0";
          megaMenu.style.transform = "translateX(-50%) translateY(-10px)";
          hoverTimeout = setTimeout(() => {
            megaMenu.style.display = "none";
          }, 200);
        });
      }
    });
  });
</script>

<style>
  .mega-menu {
    opacity: 0;
    transform: translateX(-50%) translateY(-10px);
    transition: all 0.2s ease-out;
    pointer-events: auto;
  }

  .mega-menu-item:hover {
    transform: translateX(4px);
    background: linear-gradient(135deg, rgba(212, 175, 55, 0.05) 0%, rgba(212, 175, 55, 0.1) 100%);
  }

  @media (max-width: 1279px) {
    .mega-menu {
      display: none !important;
    }
  }
</style>

<!-- 
  Use to highlight the active link in the navigation bar
  Gotta test in dev and prod bc sometimes it doesn't work
---
const pathname = new URL(Astro.request.url).pathname;
const currentPath = pathname.slice(1); // remove the first "/"
---

<nav>
  <a class={currentPath === "" ? "active" : ""} href="/">Home</a>
  <a class={currentPath === "portfolio" ? "active" : ""} href="/portfolio">Portfolio</a>
  <a class={currentPath === "posts" ? "active" : ""} href="/posts">Article</a>
  <a class={currentPath === "about" ? "active" : ""} href="/about">About Me</a>
  <a class={currentPath === "contact" ? "active" : ""} href="/contact">Contact Me</a>
</nav>
-->
